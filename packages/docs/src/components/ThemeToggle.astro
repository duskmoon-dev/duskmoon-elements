---
// ThemeToggle - dropdown theme controller using @duskmoon-dev/core theme-controller styles
import { readFileSync } from 'node:fs';
import { resolve } from 'node:path';

// Read theme-controller CSS at build time (Vite can't resolve the 'style' export condition)
// Walk up from cwd (packages/docs/) to find the root node_modules
const themeControllerCss = readFileSync(
  resolve(process.cwd(), '../../node_modules/@duskmoon-dev/core/dist/components/theme-controller.css'),
  'utf-8',
);

const themes = [
  { value: 'auto', label: 'Auto' },
  { value: 'moonlight', label: 'Moonlight' },
  { value: 'sunshine', label: 'Sunshine' },
];
---

<!-- Inject theme-controller CSS from core -->
<Fragment set:html={`<style>${themeControllerCss}</style>`} />

<details class="theme-controller-dropdown theme-controller-dropdown-sm theme-controller-dropdown-end">
  <summary class="theme-controller-trigger">
    <span class="current-theme-label">Theme</span>
  </summary>
  <div class="theme-controller-menu">
    {themes.map(({ value, label }) => (
      <Fragment>
        <input
          type="radio"
          name="theme"
          value={value}
          class="theme-controller-item"
          id={`theme-${value}`}
        />
        <label for={`theme-${value}`} class="theme-controller-label">{label}</label>
      </Fragment>
    ))}
  </div>
</details>

<script>
  const KNOWN_VALUES = ['auto', 'moonlight', 'sunshine'];
  const LABELS: Record<string, string> = {
    auto: 'Auto',
    moonlight: 'Moonlight',
    sunshine: 'Sunshine',
  };

  /** Resolve the effective theme for 'auto' based on system preference */
  function resolveAutoTheme(): string {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'moonlight' : 'sunshine';
  }

  function initThemeController() {
    const stored = localStorage.getItem('duskmoon-theme') || 'auto';
    const selected = KNOWN_VALUES.includes(stored) ? stored : 'auto';

    // Apply the theme
    if (selected === 'auto') {
      delete document.documentElement.dataset.theme;
    } else {
      document.documentElement.dataset.theme = selected;
    }

    // Check the matching radio
    const radio = document.querySelector<HTMLInputElement>(
      `input[name="theme"][value="${selected}"]`
    );
    if (radio) radio.checked = true;

    // Update trigger label
    document.querySelectorAll<HTMLElement>('.current-theme-label').forEach((el) => {
      el.textContent = LABELS[selected] || 'Theme';
    });
  }

  // Handle radio changes via event delegation
  document.body.addEventListener('change', (e) => {
    const radio = e.target as HTMLInputElement;
    if (radio.name !== 'theme' || !KNOWN_VALUES.includes(radio.value)) return;

    const selected = radio.value;

    if (selected === 'auto') {
      delete document.documentElement.dataset.theme;
      localStorage.removeItem('duskmoon-theme');
    } else {
      document.documentElement.dataset.theme = selected;
      localStorage.setItem('duskmoon-theme', selected);
    }

    // Update all trigger labels
    document.querySelectorAll<HTMLElement>('.current-theme-label').forEach((el) => {
      el.textContent = LABELS[selected] || 'Theme';
    });

    // Close the dropdown
    const details = radio.closest('details');
    if (details) details.open = false;
  });

  // Init on load and on Astro page transitions
  initThemeController();
  document.addEventListener('astro:after-swap', initThemeController);
</script>
