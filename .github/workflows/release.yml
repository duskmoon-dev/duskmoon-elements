name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0, 1.0.0, patch, minor, major)'
        required: true
        type: string
      dry-run:
        description: 'Dry run (do not publish)'
        required: false
        type: boolean
        default: false

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version
        id: version
        run: |
          INPUT_VERSION="${{ inputs.version }}"

          # Get current version from core package
          CURRENT_VERSION=$(jq -r '.version' packages/core/package.json)

          # Parse current version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case "$INPUT_VERSION" in
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            *)
              # Assume it's a specific version
              NEW_VERSION="$INPUT_VERSION"
              ;;
          esac

          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping version from $CURRENT_VERSION to $NEW_VERSION"

      - name: Update package versions
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Update core and bundle packages
          for pkg in packages/core packages/elements; do
            jq --arg v "$NEW_VERSION" '.version = $v' "$pkg/package.json" > tmp.json && mv tmp.json "$pkg/package.json"
            echo "Updated $pkg/package.json to $NEW_VERSION"
          done

          # Update all element packages
          for pkg in elements/*; do
            if [ -f "$pkg/package.json" ]; then
              jq --arg v "$NEW_VERSION" '.version = $v' "$pkg/package.json" > tmp.json && mv tmp.json "$pkg/package.json"
              echo "Updated $pkg/package.json to $NEW_VERSION"
            fi
          done

      - name: Build all packages
        run: bun run build:all

      - name: Setup npm auth
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

      - name: Publish packages (dry-run)
        if: ${{ inputs.dry-run }}
        run: bun run release:dry-run

      - name: Publish packages
        if: ${{ !inputs.dry-run }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Publish core first (other packages depend on it)
          echo "Publishing @duskmoon-dev/el-core..."
          cd packages/core
          if npm view @duskmoon-dev/el-core@$NEW_VERSION version >/dev/null 2>&1; then
            echo "  @duskmoon-dev/el-core@$NEW_VERSION already published, skipping"
          else
            bun publish --access public
          fi
          cd ../..

          # Publish all element packages
          for pkg in elements/*; do
            if [ -f "$pkg/package.json" ]; then
              PKG_NAME=$(basename "$pkg")
              echo "Publishing @duskmoon-dev/el-$PKG_NAME..."
              cd "$pkg"
              if npm view @duskmoon-dev/el-$PKG_NAME@$NEW_VERSION version >/dev/null 2>&1; then
                echo "  @duskmoon-dev/el-$PKG_NAME@$NEW_VERSION already published, skipping"
              else
                bun publish --access public
              fi
              cd ../..
            fi
          done

          # Publish bundle package last (depends on all elements)
          echo "Publishing @duskmoon-dev/elements..."
          cd packages/elements
          if npm view @duskmoon-dev/elements@$NEW_VERSION version >/dev/null 2>&1; then
            echo "  @duskmoon-dev/elements@$NEW_VERSION already published, skipping"
          else
            bun publish --access public
          fi
          cd ../..

          echo "All packages published!"

      - name: Commit version bump
        if: ${{ !inputs.dry-run }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"
          git add -A

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit (version already at $NEW_VERSION)"
          else
            git commit -m "chore(release): v$NEW_VERSION"
          fi

          # Only create tag if it doesn't exist
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "Tag v$NEW_VERSION already exists, skipping"
          else
            git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          fi

          git push origin main --follow-tags || true

      - name: Create GitHub Release
        if: ${{ !inputs.dry-run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new }}
          name: v${{ steps.version.outputs.new }}
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Published Packages

            | Package | Description | npm |
            |---------|-------------|-----|
            | @duskmoon-dev/el-core | Base element class with reactive properties, Shadow DOM, and theming utilities | [![npm](https://img.shields.io/npm/v/@duskmoon-dev/el-core)](https://www.npmjs.com/package/@duskmoon-dev/el-core) |
            | @duskmoon-dev/el-button | Customizable button with variants, sizes, loading state, and icon slots | [![npm](https://img.shields.io/npm/v/@duskmoon-dev/el-button)](https://www.npmjs.com/package/@duskmoon-dev/el-button) |
            | @duskmoon-dev/el-card | Flexible card container with header, body, footer, and media sections | [![npm](https://img.shields.io/npm/v/@duskmoon-dev/el-card)](https://www.npmjs.com/package/@duskmoon-dev/el-card) |
            | @duskmoon-dev/el-input | Form input with validation, labels, helper text, and prefix/suffix slots | [![npm](https://img.shields.io/npm/v/@duskmoon-dev/el-input)](https://www.npmjs.com/package/@duskmoon-dev/el-input) |
            | @duskmoon-dev/el-markdown | Markdown renderer with syntax highlighting, streaming mode for LLM output, and mermaid support | [![npm](https://img.shields.io/npm/v/@duskmoon-dev/el-markdown)](https://www.npmjs.com/package/@duskmoon-dev/el-markdown) |
            | @duskmoon-dev/elements | All DuskMoon elements in one bundle with auto-registration support | [![npm](https://img.shields.io/npm/v/@duskmoon-dev/elements)](https://www.npmjs.com/package/@duskmoon-dev/elements) |

            ## Installation

            ```bash
            # Install the bundle (includes all elements)
            bun add @duskmoon-dev/elements

            # Or install individual packages
            bun add @duskmoon-dev/el-core
            bun add @duskmoon-dev/el-button
            bun add @duskmoon-dev/el-card
            bun add @duskmoon-dev/el-input
            bun add @duskmoon-dev/el-markdown
            ```

            ## What's Changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "- @duskmoon-dev/el-core" >> $GITHUB_STEP_SUMMARY
          echo "- @duskmoon-dev/el-button" >> $GITHUB_STEP_SUMMARY
          echo "- @duskmoon-dev/el-card" >> $GITHUB_STEP_SUMMARY
          echo "- @duskmoon-dev/el-input" >> $GITHUB_STEP_SUMMARY
          echo "- @duskmoon-dev/el-markdown" >> $GITHUB_STEP_SUMMARY
          echo "- @duskmoon-dev/elements" >> $GITHUB_STEP_SUMMARY
